<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Validación de Datos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Librería para generar PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root {
            --row-height: 2.5rem;
        }

        .error-ring {
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.4);
            border-color: #ef4444 !important;
            background-color: #fef2f2;
        }
        .warning-ring {
            box-shadow: 0 0 0 3px rgba(234, 179, 8, 0.4);
            border-color: #eab308 !important;
            background-color: #fefce8;
        }
        .success-ring {
            box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.4);
            border-color: #22c55e !important;
            background-color: #f0fdf4;
        }
        .tab-active {
            border-bottom: 3px solid #3b82f6;
            color: #3b82f6;
        }

        /* Estilos para la Hoja de Entrada */
        .excel-container {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            font-size: 0.875rem;
        }

        .line-numbers {
            line-height: var(--row-height);
            text-align: center;
            background-color: #f1f5f9;
            color: #94a3b8;
            border-right: 1px solid #e2e8f0;
            user-select: none;
            padding-top: 0.5rem;
        }

        .excel-textarea {
            line-height: var(--row-height);
            padding-top: 0.5rem;
            padding-bottom: 0.5rem;
            resize: none;
            background-image: linear-gradient(#f8fafc 1px, transparent 1px);
            background-size: 100% var(--row-height);
            outline: none;
            border: none;
            overflow-y: hidden;
        }

        /* Estilo para ocultar el contenido del PDF sin usar display:none */
        #pdf-offscreen-container {
            position: absolute;
            left: -9999px;
            top: -9999px;
            width: 210mm; /* Ancho A4 */
        }
    </style>
</head>
<body class="bg-slate-50 min-h-screen font-sans text-slate-800">

    <div class="max-w-5xl mx-auto py-8 px-4">
        <header class="text-center mb-8">
            <h1 class="text-3xl font-bold text-slate-900 mb-2">MAPA DE EXPORTACION</h1>
            <p class="text-slate-600">TRAXION RECIBO Y EXPORTACION.</p>
        </header>

        <!-- Navegación de Pestañas -->
        <div class="flex border-b border-slate-200 mb-6 justify-center">
            <button onclick="switchTab('input-tab')" id="btn-input-tab" class="px-6 py-3 font-medium transition-colors tab-active">
                1. Hoja de Entrada
            </button>
            <button onclick="switchTab('verify-tab')" id="btn-verify-tab" class="px-6 py-3 font-medium text-slate-500 hover:text-blue-500 transition-colors">
                2. Hoja de Verificación
            </button>
        </div>

        <!-- Contenido Pestaña 1: Entrada Masiva -->
        <div id="input-tab" class="bg-white rounded-xl shadow-sm p-6 border border-slate-100">
            <div class="flex justify-between items-center mb-4">
                <div>
                    <h2 class="text-xl font-semibold">Unidades de almacenamiento de la Delivery</h2>
                    <p class="text-sm text-slate-500">Pega aquí las HU (Máximo 30 líneas).</p>
                </div>
                <button onclick="clearMaster()" class="px-3 py-1 text-xs font-semibold text-red-600 border border-red-200 rounded-md hover:bg-red-50 transition-colors">
                    Limpiar Todo
                </button>
            </div>
            
            <div class="excel-container relative border border-slate-200 rounded-lg overflow-hidden bg-white flex">
                <div class="line-numbers w-12 flex-shrink-0" id="num-sidebar">
                    <script>
                        for(let i=1; i<=30; i++) document.write(i + '<br>');
                    </script>
                </div>
                <textarea id="master-textarea" 
                    class="excel-textarea w-full h-[1220px] px-4"
                    placeholder="Pega aquí los datos maestros..."
                    oninput="handleInput(this)"
                    onkeydown="limitLines(event)"></textarea>
            </div>
            <div class="mt-3 flex justify-between items-center px-2">
                <span class="text-[10px] text-slate-400 uppercase font-bold tracking-widest">Capacidad fija: 30 líneas</span>
                <div class="text-sm font-medium text-slate-500" id="line-counter">
                    Líneas: 0 / 30
                </div>
            </div>
        </div>

        <!-- Contenido Pestaña 2: Verificación -->
        <div id="verify-tab" class="hidden bg-white rounded-xl shadow-sm p-6 border border-slate-100">
            
            <!-- Sección de Metadatos -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 p-4 bg-slate-50 rounded-lg border border-slate-100">
                <div class="flex flex-col gap-1">
                    <label class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Folio</label>
                    <input type="text" id="input-folio" class="p-2 border border-slate-200 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400 text-sm shadow-sm" placeholder="Ingresar Folio">
                </div>
                <div class="flex flex-col gap-1">
                    <label class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Destino</label>
                    <input type="text" id="input-destino" class="p-2 border border-slate-200 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400 text-sm shadow-sm" placeholder="Ingresar Destino">
                </div>
                <div class="flex flex-col gap-1">
                    <label class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Rampa</label>
                    <input type="text" id="input-rampa" class="p-2 border border-slate-200 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400 text-sm shadow-sm" placeholder="Ingresar Rampa">
                </div>
            </div>

            <div class="flex justify-between items-center mb-6">
                <div>
                    <h2 class="text-xl font-semibold">Verificación de la carga</h2>
                    <div class="flex gap-4 mt-2">
                        <span class="flex items-center text-xs text-slate-500">
                            <span class="w-3 h-3 bg-red-400 rounded-sm mr-1.5 shadow-sm"></span> Error
                        </span>
                        <span class="flex items-center text-xs text-slate-500">
                            <span class="w-3 h-3 bg-yellow-400 rounded-sm mr-1.5 shadow-sm"></span> Duplicado
                        </span>
                        <span class="flex items-center text-xs text-slate-500">
                            <span class="w-3 h-3 bg-green-400 rounded-sm mr-1.5 shadow-sm"></span> Correcto
                        </span>
                    </div>
                </div>
                <div class="space-x-2">
                    <button onclick="clearVerify()" class="border border-slate-200 hover:bg-slate-50 px-4 py-2 rounded-lg text-sm transition-all shadow-sm">
                        Reiniciar Hoja
                    </button>
                </div>
            </div>

            <div id="status-box" class="hidden mb-6 p-4 rounded-lg border"></div>

            <!-- Grid de Verificación -->
            <div class="grid grid-cols-2 gap-x-12 gap-y-4 mb-8" id="verify-grid-main"></div>

            <div class="pt-6 border-t border-slate-100 text-center">
                <button onclick="exportToPDF()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-10 py-3 rounded-xl font-bold transition-all shadow-lg active:scale-95 flex items-center gap-2 mx-auto">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    Exportar a PDF
                </button>
            </div>
        </div>
    </div>

    <!-- CONTENEDOR PARA PDF (FUERA DE PANTALLA PARA CAPTURA) -->
    <div id="pdf-offscreen-container">
        <div id="pdf-printable-content" style="padding: 10mm; background: white; width: 190mm; margin: 0 auto; min-height: 270mm;">
            <!-- Título -->
            <div style="text-align: center; border-bottom: 3px solid #000; padding-bottom: 10px; margin-bottom: 20px;">
                <h1 style="font-size: 26px; margin: 0; font-weight: 900; color: #000; letter-spacing: 1px;">MAPA DE CARGA DE EXPORTACION</h1>
                <p style="margin: 8px 0 0 0; color: #444; font-size: 12px; font-weight: bold;" id="pdf-date-val"></p>
            </div>
            
            <!-- Encabezados -->
            <table style="width: 100%; border-collapse: collapse; margin-bottom: 25px;">
                <tr>
                    <td style="width: 33.33%; padding: 10px; border: 1px solid #ddd; background: #f8f8f8;">
                        <div style="font-size: 10px; font-weight: 800; color: #666; text-transform: uppercase;">Folio</div>
                        <div id="pdf-folio-val" style="font-size: 16px; font-weight: bold; color: #000; margin-top: 4px;">-</div>
                    </td>
                    <td style="width: 33.33%; padding: 10px; border: 1px solid #ddd; background: #f8f8f8;">
                        <div style="font-size: 10px; font-weight: 800; color: #666; text-transform: uppercase;">Destino</div>
                        <div id="pdf-destino-val" style="font-size: 16px; font-weight: bold; color: #000; margin-top: 4px;">-</div>
                    </td>
                    <td style="width: 33.33%; padding: 10px; border: 1px solid #ddd; background: #f8f8f8;">
                        <div style="font-size: 10px; font-weight: 800; color: #666; text-transform: uppercase;">Rampa</div>
                        <div id="pdf-rampa-val" style="font-size: 16px; font-weight: bold; color: #000; margin-top: 4px;">-</div>
                    </td>
                </tr>
            </table>

            <!-- Listado Principal (Manteniendo orden lateral 1-2, 3-4...) -->
            <div id="pdf-items-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 0 40px; border-top: 1px solid #eee;">
                <!-- Items se llenan por JS -->
            </div>

            <div style="margin-top: 40px; border-top: 1px solid #eee; padding-top: 10px; text-align: center; font-size: 10px; color: #999;">
                *** Fin del documento - TRAXION Recibo y Exportación ***
            </div>
        </div>
    </div>

    <script>
        window.onload = () => {
            const verifyGrid = document.getElementById('verify-grid-main');
            for (let i = 1; i <= 30; i++) {
                verifyGrid.innerHTML += `
                    <div class="flex items-center group">
                        <span class="text-[10px] font-bold text-slate-300 w-8 group-hover:text-blue-400 transition-colors">${i}</span>
                        <input type="text" 
                            class="verify-group w-full p-2.5 border border-slate-200 rounded-lg focus:outline-none text-sm transition-all bg-white shadow-sm" 
                            placeholder="Dato..." 
                            oninput="validateData()">
                    </div>
                `;
            }
        };

        function limitLines(e) {
            const textarea = e.target;
            const lines = textarea.value.split('\n');
            if (e.key === 'Enter' && lines.length >= 30) e.preventDefault();
        }

        function handleInput(textarea) {
            let lines = textarea.value.split('\n');
            if (lines.length > 30) textarea.value = lines.slice(0, 30).join('\n');
            updateCount();
            if (!document.getElementById('verify-tab').classList.contains('hidden')) validateData();
        }

        function updateCount() {
            const text = document.getElementById('master-textarea').value;
            const lines = text === "" ? [] : text.split('\n');
            const counter = document.getElementById('line-counter');
            counter.innerText = `Líneas: ${lines.length} / 30`;
            counter.className = lines.length >= 30 ? "text-sm font-bold text-blue-600" : "text-sm font-medium text-slate-500";
        }

        function switchTab(tabId) {
            document.getElementById('input-tab').classList.toggle('hidden', tabId !== 'input-tab');
            document.getElementById('verify-tab').classList.toggle('hidden', tabId !== 'verify-tab');
            document.getElementById('btn-input-tab').className = `px-6 py-3 font-medium transition-colors ${tabId === 'input-tab' ? 'tab-active' : 'text-slate-500 hover:text-blue-500'}`;
            document.getElementById('btn-verify-tab').className = `px-6 py-3 font-medium transition-colors ${tabId === 'verify-tab' ? 'tab-active' : 'text-slate-500 hover:text-blue-500'}`;
            if (tabId === 'verify-tab') validateData();
        }

        function clearMaster() {
            document.getElementById('master-textarea').value = '';
            updateCount();
            if (!document.getElementById('verify-tab').classList.contains('hidden')) validateData();
        }

        function clearVerify() {
            document.querySelectorAll('.verify-group').forEach(input => {
                input.value = '';
                input.className = "verify-group w-full p-2.5 border border-slate-200 rounded-lg focus:outline-none text-sm transition-all bg-white shadow-sm";
            });
            document.getElementById('status-box').classList.add('hidden');
            ['input-folio', 'input-destino', 'input-rampa'].forEach(id => document.getElementById(id).value = '');
        }

        function validateData() {
            const masterText = document.getElementById('master-textarea').value;
            const masterData = masterText.split('\n').map(line => line.trim()).filter(line => line !== "");
            const verifyInputs = Array.from(document.querySelectorAll('.verify-group'));
            const verifyValues = verifyInputs.map(input => input.value.trim());
            const freqMap = {};
            verifyValues.forEach(val => { if (val !== "") freqMap[val] = (freqMap[val] || 0) + 1; });

            let errorCount = 0, duplicateCount = 0, successCount = 0;

            verifyInputs.forEach((input) => {
                const val = input.value.trim();
                const baseClass = "verify-group w-full p-2.5 border rounded-lg focus:outline-none text-sm transition-all shadow-sm ";
                input.className = baseClass + "border-slate-200 bg-white";
                if (val === "") return;

                if (!masterData.includes(val)) {
                    input.className = baseClass + "error-ring";
                    errorCount++;
                } else if (freqMap[val] > 1) {
                    input.className = baseClass + "warning-ring";
                    duplicateCount++;
                } else {
                    input.className = baseClass + "success-ring";
                    successCount++;
                }
            });

            const statusBox = document.getElementById('status-box');
            if (masterData.length === 0 && verifyValues.some(v => v !== "")) {
                statusBox.className = "mb-6 p-4 rounded-lg border border-red-200 bg-red-50 text-red-700";
                statusBox.innerHTML = "❌ No hay datos de referencia en la Hoja 1.";
                statusBox.classList.remove('hidden');
            } else if (errorCount > 0 || duplicateCount > 0) {
                statusBox.className = "mb-6 p-4 rounded-lg border border-orange-200 bg-orange-50 text-orange-800";
                statusBox.innerHTML = `⚠️ <b>Análisis:</b> ${errorCount} incorrectos y ${duplicateCount} duplicados encontrados.`;
                statusBox.classList.remove('hidden');
            } else if (successCount > 0) {
                statusBox.className = "mb-6 p-4 rounded-lg border border-green-200 bg-green-50 text-green-700";
                statusBox.innerHTML = "✅ <b>Verificación Exitosa:</b> Todos los datos ingresados son correctos.";
                statusBox.classList.remove('hidden');
            } else {
                statusBox.classList.add('hidden');
            }
        }

        async function exportToPDF() {
            const btn = event.currentTarget;
            const originalText = btn.innerHTML;

            // Mapeo de datos al PDF
            document.getElementById('pdf-folio-val').innerText = document.getElementById('input-folio').value || "N/A";
            document.getElementById('pdf-destino-val').innerText = document.getElementById('input-destino').value || "N/A";
            document.getElementById('pdf-rampa-val').innerText = document.getElementById('input-rampa').value || "N/A";
            document.getElementById('pdf-date-val').innerText = "FECHA: " + new Date().toLocaleString('es-MX', { dateStyle: 'long', timeStyle: 'short' }).toUpperCase();

            // Llenado de la cuadrícula del PDF manteniendo el orden lateral (1-2, 3-4...)
            const itemsGrid = document.getElementById('pdf-items-grid');
            itemsGrid.innerHTML = "";

            const inputs = document.querySelectorAll('.verify-group');
            inputs.forEach((input, index) => {
                const val = input.value.trim() || "---";
                itemsGrid.innerHTML += `
                    <div style="padding: 10px 0; border-bottom: 1px solid #eee; display: flex; align-items: center;">
                        <span style="width: 25px; font-weight: bold; color: #999; font-size: 11px;">${String(index + 1).padStart(2, '0')}</span>
                        <span style="font-family: 'Courier New', Courier, monospace; font-size: 13px; color: #000; font-weight: bold;">${val}</span>
                    </div>
                `;
            });

            // Configuración de html2pdf
            const element = document.getElementById('pdf-printable-content');
            const opt = {
                margin:       0,
                filename:     `MAPA_CARGA_${(document.getElementById('input-folio').value || 'EXP').replace(/\s+/g, '_')}.pdf`,
                image:        { type: 'jpeg', quality: 1 },
                html2canvas:  { 
                    scale: 4, 
                    useCORS: true, 
                    letterRendering: true,
                    scrollY: 0
                },
                jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            try {
                btn.innerHTML = "Generando archivo...";
                btn.disabled = true;

                // Captura y descarga
                await html2pdf().set(opt).from(element).save();

                btn.innerHTML = originalText;
                btn.disabled = false;
            } catch (error) {
                console.error("Error al generar PDF:", error);
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>
