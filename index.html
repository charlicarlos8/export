<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MAPA DE CARGA EXPORTACION</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Librería para generar PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root {
            --row-height: 2.5rem;
        }

        /* Configuración del fondo con imagen al 100% de opacidad */
        body {
            position: relative;
            min-height: 100vh;
        }

        body::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('https://43725142.fs1.hubspotusercontent-na1.net/hubfs/43725142/sitio-marzo-2024/connection-bg-1.png');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            opacity: 1;
            z-index: -1;
        }

        .error-ring {
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.4);
            border-color: #ef4444 !important;
            background-color: rgba(254, 242, 242, 0.95);
        }
        .warning-ring {
            box-shadow: 0 0 0 3px rgba(234, 179, 8, 0.4);
            border-color: #eab308 !important;
            background-color: rgba(254, 252, 232, 0.95);
        }
        .success-ring {
            box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.4);
            border-color: #22c55e !important;
            background-color: rgba(240, 253, 244, 0.95);
        }
        .tab-active {
            border-bottom: 3px solid #3b82f6;
            color: #3b82f6;
        }

        /* Estilos para la Hoja de Entrada */
        .excel-container {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            font-size: 0.875rem;
        }

        .line-numbers {
            line-height: var(--row-height);
            text-align: center;
            background-color: #f1f5f9;
            color: #94a3b8;
            border-right: 1px solid #e2e8f0;
            user-select: none;
            padding-top: 0.5rem;
        }

        .excel-textarea {
            line-height: var(--row-height);
            padding-top: 0.5rem;
            padding-bottom: 0.5rem;
            resize: none;
            background-image: linear-gradient(#f8fafc 1px, transparent 1px);
            background-size: 100% var(--row-height);
            outline: none;
            border: none;
            overflow-y: hidden;
            background-color: rgba(255, 255, 255, 0.9);
        }

        #pdf-offscreen-container {
            position: absolute;
            left: -9999px;
            top: -9999px;
            width: 210mm;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            filter: grayscale(1);
        }

        /* Paneles con mayor opacidad blanca para legibilidad sobre fondo vivo */
        .glass-panel {
            background-color: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(4px);
        }
    </style>
</head>
<body class="bg-slate-50 min-h-screen font-sans text-slate-800">

    <div class="max-w-5xl mx-auto py-8 px-4">
        <!-- Encabezado de la Página -->
        <header class="flex items-center justify-center gap-6 mb-10">
            <img src="https://traxion.global/hubfs/Traxion_LogotipoCT_Gris.png" alt="Logo Traxion" class="h-14 w-auto object-contain">
            <div class="flex flex-col text-left border-l border-slate-300 pl-6">
                <h1 class="text-4xl font-bold text-slate-900 leading-none">MAPA DE EXPORTACION</h1>
                <p class="text-slate-800 font-semibold mt-2 text-sm uppercase tracking-wide">RECIBO Y EXPORTACION</p>
            </div>
        </header>

        <!-- Navegación de Pestañas -->
        <div class="flex border-b border-slate-200 mb-6 justify-center bg-white/80 backdrop-blur-md rounded-t-lg shadow-sm">
            <button onclick="switchTab('input-tab')" id="btn-input-tab" class="px-6 py-3 font-medium transition-colors tab-active">
                1. Hoja de Entrada
            </button>
            <button onclick="switchTab('verify-tab')" id="btn-verify-tab" class="px-6 py-3 font-medium text-slate-500 hover:text-blue-500 transition-colors">
                2. Hoja de Verificación
            </button>
        </div>

        <!-- Contenido Pestaña 1: Entrada Masiva -->
        <div id="input-tab" class="glass-panel rounded-xl shadow-lg p-6 border border-white/20">
            <div class="flex justify-between items-center mb-4">
                <div>
                    <h2 class="text-xl font-semibold">Registro de Unidades de Almacenamiento</h2>
                    <p class="text-sm text-slate-500">Ingresa las HU confirmadas en la delivery (Máximo 30 líneas).</p>
                </div>
                <button onclick="clearMaster()" class="px-3 py-1 text-xs font-semibold text-red-600 border border-red-200 rounded-md hover:bg-red-50 transition-colors bg-white/80">
                    Limpiar Todo
                </button>
            </div>
            
            <div class="excel-container relative border border-slate-200 rounded-lg overflow-hidden bg-white/95 flex">
                <div class="line-numbers w-12 flex-shrink-0" id="num-sidebar">
                    <script>
                        for(let i=1; i<=30; i++) document.write(i + '<br>');
                    </script>
                </div>
                <textarea id="master-textarea" 
                    class="excel-textarea w-full h-[1220px] px-4"
                    placeholder="Pega aquí los HU..."
                    oninput="handleInput(this)"
                    onkeydown="limitLines(event)"></textarea>
            </div>
            <div class="mt-3 flex justify-between items-center px-2">
                <span class="text-[10px] text-slate-500 uppercase font-bold tracking-widest bg-white/40 px-2 rounded">Capacidad fija: 30 líneas</span>
                <div class="text-sm font-medium text-slate-700 bg-white/40 px-2 rounded" id="line-counter">
                    Líneas: 0 / 30
                </div>
            </div>
        </div>

        <!-- Contenido Pestaña 2: Verificación -->
        <div id="verify-tab" class="hidden glass-panel rounded-xl shadow-lg p-6 border border-white/20">
            
            <!-- Sección de Metadatos -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 p-4 bg-white/80 rounded-lg border border-slate-100 shadow-sm">
                <div class="flex flex-col gap-1">
                    <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Folio</label>
                    <input type="text" id="input-folio" class="p-2 border border-slate-200 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400 text-sm shadow-sm bg-white" placeholder="Ingresar Folio">
                </div>
                <div class="flex flex-col gap-1">
                    <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Destino</label>
                    <input type="text" id="input-destino" class="p-2 border border-slate-200 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400 text-sm shadow-sm bg-white" placeholder="Ingresar Destino">
                </div>
                <div class="flex flex-col gap-1">
                    <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Rampa</label>
                    <input type="text" id="input-rampa" class="p-2 border border-slate-200 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400 text-sm shadow-sm bg-white" placeholder="Ingresar Rampa">
                </div>
            </div>

            <div class="flex justify-between items-center mb-6">
                <div class="bg-white/60 p-2 rounded-lg backdrop-blur-sm">
                    <h2 class="text-xl font-semibold">Verificación de la carga.</h2>
                    <div class="flex gap-4 mt-2">
                        <span class="flex items-center text-xs text-slate-700">
                            <span class="w-3 h-3 bg-red-400 rounded-sm mr-1.5 shadow-sm"></span> Error
                        </span>
                        <span class="flex items-center text-xs text-slate-700">
                            <span class="w-3 h-3 bg-yellow-400 rounded-sm mr-1.5 shadow-sm"></span> Duplicado
                        </span>
                        <span class="flex items-center text-xs text-slate-700">
                            <span class="w-3 h-3 bg-green-400 rounded-sm mr-1.5 shadow-sm"></span> Correcto
                        </span>
                    </div>
                </div>
                <div class="space-x-2">
                    <button onclick="clearVerify()" class="border border-slate-200 hover:bg-slate-50 px-4 py-2 rounded-lg text-sm transition-all shadow-sm bg-white/90">
                        Reiniciar Hoja
                    </button>
                </div>
            </div>

            <div id="status-box" class="hidden mb-6 p-4 rounded-lg border shadow-sm"></div>

            <!-- Grid de Verificación -->
            <div class="grid grid-cols-2 gap-x-12 gap-y-4 mb-8" id="verify-grid-main"></div>

            <!-- Panel de Control de Carga y Botón PDF -->
            <div class="pt-6 border-t border-slate-200 flex flex-col md:flex-row items-center justify-between gap-6">
                <!-- Mensaje de Estado de Carga -->
                <div id="load-status-container" class="flex-1 w-full p-4 rounded-xl border flex flex-col gap-2 bg-white shadow-md">
                    <div class="flex items-center justify-between">
                        <span class="text-xs font-bold uppercase tracking-wider text-slate-400">Estado de la Carga</span>
                        <span id="load-status-badge" class="px-2 py-0.5 rounded text-[10px] font-black uppercase">Incompleta</span>
                    </div>
                    <div id="load-status-msg" class="text-sm font-semibold text-slate-800">Esperando datos...</div>
                    <div id="missing-data-area" class="hidden">
                        <p class="text-[10px] text-slate-400 uppercase font-bold mt-1">Faltan por ingresar:</p>
                        <div id="missing-data-list" class="flex flex-wrap gap-1 mt-1 text-[11px] font-mono"></div>
                    </div>
                </div>

                <!-- Botón Exportar PDF -->
                <button id="btn-export-pdf" onclick="exportToPDF()" disabled class="bg-emerald-600 hover:bg-emerald-700 text-white px-10 py-4 rounded-xl font-bold transition-all shadow-lg active:scale-95 flex items-center gap-2 whitespace-nowrap">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    Exportar a PDF
                </button>
            </div>
        </div>
    </div>

    <!-- CONTENEDOR PARA PDF (FUERA DE PANTALLA) -->
    <div id="pdf-offscreen-container">
        <div id="pdf-printable-content" style="padding: 10mm; background: white; width: 190mm; margin: 0 auto; min-height: 270mm;">
            <!-- Encabezado del PDF con Logo solicitado -->
            <div style="display: flex; align-items: center; justify-content: center; gap: 20px; border-bottom: 3px solid #000; padding-bottom: 15px; margin-bottom: 20px;">
                <img src="https://traxion.global/hubfs/Traxion_LogotipoCT_Gris.png" style="height: 40px; width: auto; object-contain: contain;">
                <div style="text-align: center;">
                    <h1 style="font-size: 24px; margin: 0; font-weight: 900; color: #000; letter-spacing: 1px; text-transform: uppercase;">MAPA DE CARGA DE EXPORTACION</h1>
                    <p style="margin: 5px 0 0 0; color: #444; font-size: 11px; font-weight: bold;" id="pdf-date-val"></p>
                </div>
            </div>
            
            <table style="width: 100%; border-collapse: collapse; margin-bottom: 25px;">
                <tr>
                    <td style="width: 33.33%; padding: 10px; border: 1px solid #ddd; background: #f8f8f8;">
                        <div style="font-size: 10px; font-weight: 800; color: #666; text-transform: uppercase;">Folio</div>
                        <div id="pdf-folio-val" style="font-size: 16px; font-weight: bold; color: #000; margin-top: 4px;">-</div>
                    </td>
                    <td style="width: 33.33%; padding: 10px; border: 1px solid #ddd; background: #f8f8f8;">
                        <div style="font-size: 10px; font-weight: 800; color: #666; text-transform: uppercase;">Destino</div>
                        <div id="pdf-destino-val" style="font-size: 16px; font-weight: bold; color: #000; margin-top: 4px;">-</div>
                    </td>
                    <td style="width: 33.33%; padding: 10px; border: 1px solid #ddd; background: #f8f8f8;">
                        <div style="font-size: 10px; font-weight: 800; color: #666; text-transform: uppercase;">Rampa</div>
                        <div id="pdf-rampa-val" style="font-size: 16px; font-weight: bold; color: #000; margin-top: 4px;">-</div>
                    </td>
                </tr>
            </table>

            <div id="pdf-items-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 0 40px; border-top: 1px solid #eee;"></div>

            <div style="margin-top: 40px; border-top: 1px solid #eee; padding-top: 10px; text-align: center; font-size: 10px; color: #999;">
                *** Fin del documento - TRAXION Recibo y Exportación ***
            </div>
        </div>
    </div>

    <script>
        window.onload = () => {
            const verifyGrid = document.getElementById('verify-grid-main');
            for (let i = 1; i <= 30; i++) {
                verifyGrid.innerHTML += `
                    <div class="flex items-center group">
                        <span class="text-[10px] font-bold text-slate-300 w-8 group-hover:text-blue-400 transition-colors">${i}</span>
                        <input type="text" 
                            class="verify-group w-full p-2.5 border border-slate-200 rounded-lg focus:outline-none text-sm transition-all bg-white/95 shadow-sm" 
                            placeholder="Dato..." 
                            oninput="validateData()">
                    </div>
                `;
            }
        };

        function limitLines(e) {
            const textarea = e.target;
            const lines = textarea.value.split('\n');
            if (e.key === 'Enter' && lines.length >= 30) e.preventDefault();
        }

        function handleInput(textarea) {
            let lines = textarea.value.split('\n');
            if (lines.length > 30) textarea.value = lines.slice(0, 30).join('\n');
            updateCount();
            if (!document.getElementById('verify-tab').classList.contains('hidden')) validateData();
        }

        function updateCount() {
            const text = document.getElementById('master-textarea').value;
            const lines = text === "" ? [] : text.split('\n');
            const counter = document.getElementById('line-counter');
            counter.innerText = `Líneas: ${lines.length} / 30`;
            counter.className = lines.length >= 30 ? "text-sm font-bold text-blue-600" : "text-sm font-medium text-slate-500";
        }

        function switchTab(tabId) {
            document.getElementById('input-tab').classList.toggle('hidden', tabId !== 'input-tab');
            document.getElementById('verify-tab').classList.toggle('hidden', tabId !== 'verify-tab');
            document.getElementById('btn-input-tab').className = `px-6 py-3 font-medium transition-colors ${tabId === 'input-tab' ? 'tab-active' : 'text-slate-500 hover:text-blue-500'}`;
            document.getElementById('btn-verify-tab').className = `px-6 py-3 font-medium transition-colors ${tabId === 'verify-tab' ? 'tab-active' : 'text-slate-500 hover:text-blue-500'}`;
            if (tabId === 'verify-tab') validateData();
        }

        function clearMaster() {
            document.getElementById('master-textarea').value = '';
            updateCount();
            if (!document.getElementById('verify-tab').classList.contains('hidden')) validateData();
        }

        function clearVerify() {
            document.querySelectorAll('.verify-group').forEach(input => {
                input.value = '';
                input.className = "verify-group w-full p-2.5 border border-slate-200 rounded-lg focus:outline-none text-sm transition-all bg-white/95 shadow-sm";
            });
            document.getElementById('status-box').classList.add('hidden');
            ['input-folio', 'input-destino', 'input-rampa'].forEach(id => document.getElementById(id).value = '');
            validateData();
        }

        function validateData() {
            const masterText = document.getElementById('master-textarea').value;
            const masterDataRaw = masterText.split('\n').map(line => line.trim()).filter(line => line !== "");
            const masterData = [...new Set(masterDataRaw)];

            const verifyInputs = Array.from(document.querySelectorAll('.verify-group'));
            const verifyValues = verifyInputs.map(input => input.value.trim());
            
            const freqMap = {};
            verifyValues.forEach(val => { if (val !== "") freqMap[val] = (freqMap[val] || 0) + 1; });

            let errorCount = 0, duplicateCount = 0, successCount = 0;
            const foundInVerify = new Set();

            verifyInputs.forEach((input) => {
                const val = input.value.trim();
                const baseClass = "verify-group w-full p-2.5 border rounded-lg focus:outline-none text-sm transition-all shadow-sm ";
                input.className = baseClass + "border-slate-200 bg-white/95";
                if (val === "") return;

                if (!masterData.includes(val)) {
                    input.className = baseClass + "error-ring";
                    errorCount++;
                } else if (freqMap[val] > 1) {
                    input.className = baseClass + "warning-ring";
                    duplicateCount++;
                } else {
                    input.className = baseClass + "success-ring";
                    successCount++;
                    foundInVerify.add(val);
                }
            });

            const missingData = masterData.filter(item => !foundInVerify.has(item));
            const isComplete = masterData.length > 0 && missingData.length === 0 && errorCount === 0 && duplicateCount === 0;
            
            updateLoadStatus(isComplete, missingData, masterData.length, foundInVerify.size);

            const statusBox = document.getElementById('status-box');
            if (masterData.length === 0 && verifyValues.some(v => v !== "")) {
                statusBox.className = "mb-6 p-4 rounded-lg border border-red-200 bg-red-100/90 text-red-800 text-center font-bold";
                statusBox.innerHTML = "❌ No hay datos de referencia en la Hoja 1.";
                statusBox.classList.remove('hidden');
            } else {
                statusBox.classList.add('hidden');
            }
        }

        function updateLoadStatus(isComplete, missing, totalMaster, totalFound) {
            const container = document.getElementById('load-status-container');
            const badge = document.getElementById('load-status-badge');
            const msg = document.getElementById('load-status-msg');
            const missingArea = document.getElementById('missing-data-area');
            const missingList = document.getElementById('missing-data-list');
            const btnPdf = document.getElementById('btn-export-pdf');

            if (totalMaster === 0) {
                container.className = "flex-1 w-full p-4 rounded-xl border border-slate-200 bg-white shadow-inner";
                badge.className = "px-2 py-0.5 rounded text-[10px] font-black uppercase bg-slate-200 text-slate-500";
                badge.innerText = "Sin Datos";
                msg.innerText = "Por favor, ingresa los datos maestros en la Hoja 1.";
                missingArea.classList.add('hidden');
                btnPdf.disabled = true;
                return;
            }

            if (isComplete) {
                container.className = "flex-1 w-full p-4 rounded-xl border border-green-200 bg-green-50 flex flex-col gap-2 shadow-inner";
                badge.className = "px-2 py-0.5 rounded text-[10px] font-black uppercase bg-green-600 text-white";
                badge.innerText = "Completa";
                msg.className = "text-sm font-semibold text-green-700";
                msg.innerText = `Carga de datos completa (${totalFound}/${totalMaster})`;
                missingArea.classList.add('hidden');
                btnPdf.disabled = false;
            } else {
                container.className = "flex-1 w-full p-4 rounded-xl border border-red-100 bg-red-50 flex flex-col gap-2 shadow-inner";
                badge.className = "px-2 py-0.5 rounded text-[10px] font-black uppercase bg-red-500 text-white";
                badge.innerText = "Incompleta";
                msg.className = "text-sm font-semibold text-red-700";
                msg.innerText = `Carga de datos incompleta. Faltan ${missing.length} registros.`;
                missingArea.classList.remove('hidden');
                missingList.innerHTML = missing.map(item => `<span class="bg-red-200 text-red-800 px-2 py-0.5 rounded border border-red-300 font-bold">${item}</span>`).join('');
                btnPdf.disabled = true;
            }
        }

        async function exportToPDF() {
            const btn = document.getElementById('btn-export-pdf');
            const originalText = btn.innerHTML;

            document.getElementById('pdf-folio-val').innerText = (document.getElementById('input-folio').value || "N/A").toUpperCase();
            document.getElementById('pdf-destino-val').innerText = (document.getElementById('input-destino').value || "N/A").toUpperCase();
            document.getElementById('pdf-rampa-val').innerText = (document.getElementById('input-rampa').value || "N/A").toUpperCase();
            document.getElementById('pdf-date-val').innerText = "FECHA: " + new Date().toLocaleString('es-MX', { dateStyle: 'long', timeStyle: 'short' }).toUpperCase();

            const itemsGrid = document.getElementById('pdf-items-grid');
            itemsGrid.innerHTML = "";

            const inputs = document.querySelectorAll('.verify-group');
            inputs.forEach((input, index) => {
                const val = input.value.trim() || "---";
                itemsGrid.innerHTML += `
                    <div style="padding: 10px 0; border-bottom: 1px solid #eee; display: flex; align-items: center;">
                        <span style="width: 25px; font-weight: bold; color: #999; font-size: 11px;">${String(index + 1).padStart(2, '0')}</span>
                        <span style="font-family: 'Courier New', Courier, monospace; font-size: 13px; color: #000; font-weight: bold;">${val}</span>
                    </div>
                `;
            });

            const element = document.getElementById('pdf-printable-content');
            const opt = {
                margin: 0,
                filename: `MAPA_CARGA_${(document.getElementById('input-folio').value || 'EXP').replace(/\s+/g, '_')}.pdf`,
                image: { type: 'jpeg', quality: 1 },
                html2canvas: { scale: 4, useCORS: true, letterRendering: true, scrollY: 0 },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            try {
                btn.innerHTML = "Generando archivo...";
                btn.disabled = true;
                await html2pdf().set(opt).from(element).save();
                btn.innerHTML = originalText;
                btn.disabled = false;
            } catch (error) {
                console.error("Error PDF:", error);
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>
