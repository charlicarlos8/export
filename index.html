<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Escáner Móvil a Hoja de Cálculo</title>
    <!-- Carga de Tailwind CSS para un diseño responsivo -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Carga de la librería QuaggaJS para escaneo de códigos de barras -->
    <script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>
    <style>
        /* Estilos personalizados para el contenedor del video y la orientación */
        #interactive.viewport {
            width: 100%;
            max-width: 400px; /* Ancho máximo para mejor visualización móvil */
            height: 200px; /* Altura ajustada verticalmente */
            margin: 0 auto;
            position: relative;
            overflow: hidden;
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        #interactive.viewport video {
            width: 100%;
            height: 100%;
            object-fit: cover; /* Asegura que el video cubra el área */
        }
        /* Resalta el área de detección (el marco rojo) */
        .drawingBuffer {
            position: absolute;
            top: 0;
            left: 0;
        }
        /* Ocultar el botón de reinicio al inicio */
        #restartButton {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col p-4 font-sans antialiased">

    <!-- Contenedor Principal -->
    <div class="max-w-md w-full mx-auto bg-white rounded-xl shadow-2xl p-6 space-y-6">

        <h1 class="text-3xl font-bold text-center text-gray-800">TRANSITO DE HU A RACK</h1>
        <p class="text-center text-gray-600 text-sm">Apunta la cámara al código de barras de la HU.</p>
        
        <!-- Área de Previsualización de la Cámara -->
        <div id="interactive" class="viewport shadow-inner bg-gray-900 flex items-center justify-center">
            <div class="text-white text-center">Cargando Cámara...</div>
        </div>

        <!-- Panel de Resultado del Escaneo -->
        <div class="bg-blue-50 border-l-4 border-blue-500 text-blue-900 p-4 rounded-md shadow-md">
            <p class="font-semibold mb-1">HU Leído:</p>
            <div id="result" class="text-xl font-mono break-all bg-white p-2 rounded-lg border border-blue-200 min-h-[40px]">
                Esperando escaneo...
            </div>
            <!-- Mensaje de error para la longitud del código -->
            <div id="error-message" class="text-red-600 mt-2 hidden text-sm"></div>
        </div>

        <!-- Botones de Acción -->
        <div class="flex flex-col space-y-3">
            <button id="sendButton"
                    class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-xl shadow-lg transition duration-150 ease-in-out disabled:opacity-50"
                    disabled>
                <span id="sendText">Enviar HU</span>
                <span id="loadingSpinner" class="hidden h-5 w-5 border-4 border-white border-t-transparent rounded-full animate-spin inline-block align-middle"></span>
            </button>
            <button id="restartButton"
                    class="w-full bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-xl shadow-lg transition duration-150 ease-in-out">
                Escanear de Nuevo
            </button>
        </div>

        <!-- Modal de Notificación (Reemplaza a alert()) -->
        <div id="statusModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center p-4 z-50">
            <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full">
                <h3 id="modalTitle" class="text-lg font-semibold mb-2 text-gray-900"></h3>
                <p id="modalMessage" class="text-gray-600 mb-4"></p>
                <button id="closeModal" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded-lg">Cerrar</button>
            </div>
        </div>

    </div>

    <script>
        // --- VARIABLES DE CONFIGURACIÓN (ACTUALIZAR ESTOS VALORES) ---
        // 1. URL de envío del formulario de Google (URL de action del form, VER NOTAS)
        const FORM_URL = 'https://docs.google.com/forms/u/0/d/e/1FAIpQLSfRc0zukVq-xcOlljQVYxVEaS0EV0VI2lcV4TEPj5yZCixwAQ/formResponse';
        // 2. ID de la entrada del campo de texto del Código de Barras
        const FORM_ENTRY_ID_BARCODE = 'entry.968870866'; 
        
        // --- CONSTANTE DE VALIDACIÓN ---
        const REQUIRED_LENGTH = 20; 
        
        // --- CONSTANTE DE RETRASO ---
        const DETECTION_DELAY_MS = 1500; // 1.5 segundos de retraso

        // --- REFERENCIAS DOM ---
        const resultDisplay = document.getElementById('result');
        const sendButton = document.getElementById('sendButton');
        const restartButton = document.getElementById('restartButton');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const sendText = document.getElementById('sendText');
        const errorMessageDisplay = document.getElementById('error-message');
        const interactiveContainer = document.getElementById('interactive');

        // --- ESTADO GLOBAL ---
        let lastBarcode = null;
        let isSending = false;
        let scannerRunning = false;
        let isQuaggaInitialized = false;

        // --- FUNCIÓN DE UTILIDAD PARA EL MODAL ---
        function showModal(title, message) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalMessage').textContent = message;
            document.getElementById('statusModal').classList.remove('hidden');
        }

        // Función de validación de estado: solo comprueba el código de barras
        function checkSendAbility() {
            // Habilitar botón solo si el código es válido (no nulo y 20 caracteres)
            const hasBarcode = lastBarcode && lastBarcode.length === REQUIRED_LENGTH;
            sendButton.disabled = !hasBarcode;
        }

        // --- FUNCIÓN DE INICIALIZACIÓN DE QUAGGAJS ---
        function startScanner() {
            if (scannerRunning) return;

            // Restablece el estado de la UI
            lastBarcode = null;
            sendButton.disabled = true;
            restartButton.style.display = 'none';
            resultDisplay.textContent = 'Esperando escaneo...';
            errorMessageDisplay.classList.add('hidden');
            
            // Configuración para usar la cámara trasera y decodificar EAN/UPC
            const config = {
                inputStream: {
                    name: "Live",
                    type: "LiveStream",
                    target: interactiveContainer,
                    constraints: {
                        // Forzar el uso de la cámara trasera y alta resolución
                        facingMode: "environment", 
                        // Constraints específicos para mejorar la compatibilidad en móviles
                        width: { min: 640 },
                        height: { min: 480 }
                    },
                },
                // Ajustes de localización para mejorar la precisión y velocidad
                locator: {
                    patchSize: "medium", // Tamaño del parche para la detección
                    halfSample: true, // Usa muestreo reducido para velocidad
                    // Definir una zona de interés (centro de la imagen)
                    area: {
                        top: "20%",
                        right: "20%",
                        left: "20%",
                        bottom: "20%"
                    }
                },
                // Ajustes de decodificación
                decoder: {
                    readers: ["ean_reader", "upc_reader", "code_128_reader", "code_39_reader", "i2of5_reader"],
                    multiple: false // Solo buscamos un código a la vez
                }
            };
            
            // Muestra mensaje de carga
            const loadingDiv = document.querySelector('#interactive div');
            if(loadingDiv) {
                loadingDiv.textContent = 'Cargando Cámara...';
                loadingDiv.style.display = 'block'; 
            }

            // Inicia Quagga
            Quagga.init(config, function(err) {
                if (err) {
                    console.error("Error al inicializar Quagga:", err);
                    errorMessageDisplay.textContent = 'Error al iniciar la cámara: ' + err.message + '. Asegúrate de tener una cámara trasera disponible.';
                    errorMessageDisplay.classList.remove('hidden');
                    if(loadingDiv) loadingDiv.textContent = 'Error: No se pudo acceder a la cámara.';
                    return;
                }
                
                Quagga.start();
                if (loadingDiv) loadingDiv.style.display = 'none'; // Oculta el mensaje al activar la cámara

                scannerRunning = true;
                isQuaggaInitialized = true;
            });
            
            // Manejador para dibujar el marco de localización, útil para debugging
            Quagga.onProcessed(function(result) {
                const drawingCtx = Quagga.canvas.ctx.overlay;
                const drawingCanvas = Quagga.canvas.dom.overlay;

                if (result) {
                    if (result.boxes) {
                        drawingCtx.clearRect(0, 0, parseInt(drawingCanvas.getAttribute("width")), parseInt(drawingCanvas.getAttribute("height")));
                        result.boxes.filter(function (box) {
                            return box !== result.box;
                        }).forEach(function (box) {
                            Quagga.ImageDebug.drawPath(box, {x: 0, y: 1}, drawingCtx, {color: "green", lineWidth: 2});
                        });
                    }

                    if (result.box) {
                        Quagga.ImageDebug.drawPath(result.box, {x: 0, y: 1}, drawingCtx, {color: "#00F", lineWidth: 2});
                    }

                    if (result.codeResult && result.line) {
                        Quagga.ImageDebug.drawPath(result.line, {x: 'x', y: 'y'}, drawingCtx, {color: "red", lineWidth: 3});
                    }
                }
            });
        }

        // --- MANEJADOR DE ESCANEO EXITOSO (CON DELAY) ---
        Quagga.onDetected(function(data) {
            if (scannerRunning) {
                
                // Captura el código inmediatamente, pero establece la bandera a false
                // para ignorar detecciones adicionales mientras esperamos el delay.
                scannerRunning = false; 
                const detectedCode = data.codeResult.code;

                // Retraso de 1.5 segundos antes de detener la cámara y mostrar el resultado final
                setTimeout(() => {
                    Quagga.stop();
                    
                    lastBarcode = detectedCode;
                    resultDisplay.textContent = lastBarcode;
                    
                    // 1. Verifica la longitud del código de barras (20 caracteres)
                    if (lastBarcode.length === REQUIRED_LENGTH) {
                        errorMessageDisplay.classList.add('hidden');
                    } else {
                        errorMessageDisplay.textContent = `Código leído (${lastBarcode.length} caracteres) no tiene la longitud requerida de ${REQUIRED_LENGTH} caracteres.`;
                        errorMessageDisplay.classList.remove('hidden');
                    }

                    restartButton.style.display = 'block';
                    checkSendAbility(); // Habilita o deshabilita el botón 'Enviar'
                }, DETECTION_DELAY_MS);
            }
        });

        // --- FUNCIÓN PARA ENVIAR DATOS A GOOGLE SHEET VÍA FORMULARIO ---
        async function sendToGoogleSheet() {
            if (!lastBarcode || isSending) return;

            if (FORM_URL.includes('REEMPLAZAR') || FORM_ENTRY_ID_BARCODE.includes('REEMPLAZAR')) {
                showModal('Error de Configuración', 'Las variables de URL y Entry ID no han sido configuradas. Revisa FORM_URL y FORM_ENTRY_ID_BARCODE.');
                return;
            }

            // Validar longitud del código de barras COMPLETO
            if (lastBarcode.length !== REQUIRED_LENGTH) {
                showModal('Error de Validación', `El código de barras debe tener exactamente ${REQUIRED_LENGTH} caracteres para ser enviado.`);
                return; 
            }

            // --- LÓGICA DE TRUNCAMIENTO: Eliminar los primeros dos dígitos ---
            const trimmedBarcode = lastBarcode.substring(2);

            isSending = true;
            sendButton.disabled = true;
            sendText.classList.add('hidden');
            loadingSpinner.classList.remove('hidden');
            restartButton.disabled = true;
            
            // Construir FormData
            const formData = new FormData();
            // AQUI se envía el código recortado (trimmedBarcode)
            formData.append(FORM_ENTRY_ID_BARCODE, trimmedBarcode); 
            
            try {
                const response = await fetch(FORM_URL, {
                    method: 'POST',
                    mode: 'no-cors', 
                    body: formData
                });

                // Mensaje de éxito informando el código que realmente se envió
                showModal('¡Éxito!', `HU enviado: "${trimmedBarcode}".`);

                // Preparar para el próximo escaneo
                lastBarcode = null;
                resultDisplay.textContent = 'Esperando escaneo...';
                
            } catch (error) {
                console.error("Error al enviar a Google Sheet:", error);
                showModal('Error de Envío', 'Hubo un error de conexión al enviar el dato. Verifica la URL del Formulario.');
            } finally {
                isSending = false;
                sendText.classList.remove('hidden');
                loadingSpinner.classList.add('hidden');
                restartButton.disabled = false;
                checkSendAbility();
            }
        }

        // --- MANEJADORES DE EVENTOS ---

        // Inicia el escáner cuando la página se carga
        window.onload = startScanner;

        // Botón Enviar
        sendButton.addEventListener('click', sendToGoogleSheet);
        
        // Botón Escanear de Nuevo (Reinicia el escáner)
        restartButton.addEventListener('click', function() {
            if (!scannerRunning) {
                startScanner();
            }
        });

        // Cierre del Modal
        document.getElementById('closeModal').addEventListener('click', function() {
            document.getElementById('statusModal').classList.add('hidden');
        });
        
    </script>
</body>
</html>

