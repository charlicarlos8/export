<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Escáner Móvil a Hoja de Cálculo</title>
    <!-- Carga de Tailwind CSS para un diseño responsivo -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Carga de la librería QuaggaJS para escaneo de códigos de barras -->
    <script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>
    <style>
        /* Estilos personalizados para el contenedor del video y la orientación */
        #interactive.viewport {
            width: 100%;
            max-width: 400px; /* Ancho máximo para mejor visualización móvil */
            height: 300px;
            margin: 0 auto;
            position: relative;
            overflow: hidden;
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        #interactive.viewport video {
            width: 100%;
            height: 100%;
            object-fit: cover; /* Asegura que el video cubra el área */
        }
        /* Resalta el área de detección (el marco rojo) */
        .drawingBuffer {
            position: absolute;
            top: 0;
            left: 0;
        }
        /* Ocultar el botón de reinicio al inicio */
        #restartButton {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col p-4 font-sans antialiased">

    <!-- Contenedor Principal -->
    <div class="max-w-md w-full mx-auto bg-white rounded-xl shadow-2xl p-6 space-y-6">

        <h1 class="text-3xl font-bold text-center text-gray-800">Escáner de Inventario Multi-Usuario</h1>
        <p class="text-center text-gray-600 text-sm">Apunta la cámara al código de barras.</p>

        <!-- Área de Previsualización de la Cámara -->
        <div id="interactive" class="viewport shadow-inner bg-gray-900 flex items-center justify-center">
            <div class="text-white text-center">Cargando Cámara...</div>
        </div>

        <!-- Panel de Resultado del Escaneo -->
        <div class="bg-blue-50 border-l-4 border-blue-500 text-blue-900 p-4 rounded-md shadow-md">
            <p class="font-semibold mb-1">Código Leído:</p>
            <div id="result" class="text-xl font-mono break-all bg-white p-2 rounded-lg border border-blue-200 min-h-[40px]">
                Esperando escaneo...
            </div>
            <div id="error-message" class="text-red-600 mt-2 hidden text-sm"></div>
        </div>

        <!-- Botones de Acción -->
        <div class="flex flex-col space-y-3">
            <button id="sendButton"
                    class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-xl shadow-lg transition duration-150 ease-in-out disabled:opacity-50"
                    disabled>
                <span id="sendText">Enviar Código a Google Sheet</span>
                <span id="loadingSpinner" class="hidden h-5 w-5 border-4 border-white border-t-transparent rounded-full animate-spin inline-block align-middle"></span>
            </button>
            <button id="restartButton"
                    class="w-full bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-xl shadow-lg transition duration-150 ease-in-out">
                Escanear de Nuevo
            </button>
        </div>

        <!-- Modal de Notificación (Reemplaza a alert()) -->
        <div id="statusModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center p-4 z-50">
            <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full">
                <h3 id="modalTitle" class="text-lg font-semibold mb-2 text-gray-900"></h3>
                <p id="modalMessage" class="text-gray-600 mb-4"></p>
                <button id="closeModal" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded-lg">Cerrar</button>
            </div>
        </div>

    </div>

    <script>
        // --- VARIABLES DE CONFIGURACIÓN (ACTUALIZAR ESTOS VALORES) ---
        // 1. URL de envío del formulario de Google (URL de action del form, VER NOTAS)
        const FORM_URL = 'REEMPLAZAR_CON_LA_URL_DEL_FORMULARIO_DE_GOOGLE';
        // 2. ID de la entrada del campo de texto en el formulario (e.g., entry.123456789)
        const FORM_ENTRY_ID = 'REEMPLAZAR_CON_LA_ID_DE_ENTRADA';

        // --- REFERENCIAS DOM ---
        const resultDisplay = document.getElementById('result');
        const sendButton = document.getElementById('sendButton');
        const restartButton = document.getElementById('restartButton');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const sendText = document.getElementById('sendText');
        const errorMessageDisplay = document.getElementById('error-message');
        const interactiveContainer = document.getElementById('interactive');

        // --- ESTADO GLOBAL ---
        let lastBarcode = null;
        let isSending = false;
        let scannerRunning = false;
        let isQuaggaInitialized = false;

        // --- FUNCIÓN DE UTILIDAD PARA EL MODAL ---
        function showModal(title, message) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalMessage').textContent = message;
            document.getElementById('statusModal').classList.remove('hidden');
        }

        // --- FUNCIÓN DE INICIALIZACIÓN DE QUAGGAJS ---
        function startScanner() {
            if (scannerRunning) return;

            // Restablece el estado de la UI
            lastBarcode = null;
            sendButton.disabled = true;
            restartButton.style.display = 'none';
            resultDisplay.textContent = 'Esperando escaneo...';
            errorMessageDisplay.classList.add('hidden');
            
            // Configuración para usar la cámara trasera y decodificar EAN/UPC
            const config = {
                inputStream: {
                    name: "Live",
                    type: "LiveStream",
                    target: interactiveContainer,
                    constraints: {
                        width: 640,
                        height: 480,
                        facingMode: "environment" // Pide la cámara trasera
                    },
                },
                decoder: {
                    readers: ["ean_reader", "upc_reader", "code_128_reader", "code_39_reader"] // Añadido Code 39
                }
            };
            
            // Muestra mensaje de carga
            const loadingDiv = document.querySelector('#interactive div');
            if(loadingDiv) loadingDiv.textContent = 'Cargando Cámara...';


            Quagga.init(config, function(err) {
                if (err) {
                    console.error("Error al inicializar Quagga:", err);
                    errorMessageDisplay.textContent = 'Error al iniciar la cámara: ' + err.message + '. Asegúrate de tener una cámara trasera disponible.';
                    errorMessageDisplay.classList.remove('hidden');
                    // Oculta el mensaje de carga en el viewporet
                    if(loadingDiv) loadingDiv.textContent = 'Error: No se pudo acceder a la cámara.';
                    return;
                }
                Quagga.start();
                scannerRunning = true;
                isQuaggaInitialized = true;
            });
        }

        // --- MANEJADOR DE ESCANEO EXITOSO ---
        Quagga.onDetected(function(data) {
            if (scannerRunning) {
                lastBarcode = data.codeResult.code;
                resultDisplay.textContent = lastBarcode;
                sendButton.disabled = false;
                restartButton.style.display = 'block';

                // Detener el escáner inmediatamente después de la detección exitosa
                Quagga.stop();
                scannerRunning = false;
                console.log("Escaneo exitoso y detenido. Código:", lastBarcode);
            }
        });

        // --- FUNCIÓN PARA ENVIAR DATOS A GOOGLE SHEET VÍA FORMULARIO ---
        async function sendToGoogleSheet() {
            if (!lastBarcode || isSending) {
                return;
            }
            if (FORM_URL.includes('REEMPLAZAR') || FORM_ENTRY_ID.includes('REEMPLAZAR')) {
                showModal('Error de Configuración', 'Las variables FORM_URL y FORM_ENTRY_ID no han sido configuradas. Sigue los pasos de configuración.');
                return;
            }

            isSending = true;
            sendButton.disabled = true;
            sendText.classList.add('hidden');
            loadingSpinner.classList.remove('hidden');
            restartButton.disabled = true;

            const formData = new FormData();
            formData.append(FORM_ENTRY_ID, lastBarcode);
            
            // Se usa el modo 'no-cors' para permitir el envío al endpoint de Google Forms sin un servidor
            try {
                const response = await fetch(FORM_URL, {
                    method: 'POST',
                    mode: 'no-cors', 
                    body: formData
                });

                // La respuesta es siempre "opaque" en 'no-cors', asumimos éxito si no hay error de red
                showModal('¡Éxito!', `Código: "${lastBarcode}" enviado. El próximo usuario puede escanear.`);

                // Preparar para el próximo escaneo
                lastBarcode = null;
                resultDisplay.textContent = 'Esperando escaneo...';
                
            } catch (error) {
                console.error("Error al enviar a Google Sheet:", error);
                showModal('Error de Envío', 'Hubo un error de conexión al enviar el dato. Verifica la URL del Formulario.');
            } finally {
                isSending = false;
                // El botón de enviar permanece deshabilitado hasta que se escanee un nuevo código.
                sendText.classList.remove('hidden');
                loadingSpinner.classList.add('hidden');
                restartButton.disabled = false;
            }
        }

        // --- MANEJADORES DE EVENTOS ---

        // Inicia el escáner cuando la página se carga
        window.onload = startScanner;

        // Botón Enviar
        sendButton.addEventListener('click', sendToGoogleSheet);

        // Botón Escanear de Nuevo (Reinicia el escáner)
        restartButton.addEventListener('click', function() {
            if (!scannerRunning) {
                startScanner();
            }
        });

        // Cierre del Modal
        document.getElementById('closeModal').addEventListener('click', function() {
            document.getElementById('statusModal').classList.add('hidden');
        });
        
        // Ocultar el mensaje de carga cuando Quagga inicia el video
        Quagga.onImageProcessed(function(result) {
            if (isQuaggaInitialized) {
                const loadingDiv = document.querySelector('#interactive div');
                if (loadingDiv && loadingDiv.textContent === 'Cargando Cámara...') {
                    loadingDiv.style.display = 'none';
                }
            }
        });

    </script>
</body>
</html>

